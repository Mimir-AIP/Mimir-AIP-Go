# =====================================================
# Unified Docker Compose for Mimir AIP
# Single container serving both backend API and frontend
# =====================================================
version: '3.8'

services:
  mimir-aip-unified:
    build:
      context: ..
      dockerfile: Dockerfile.unified
    image: mimir-aip:unified-latest
    container_name: mimir-aip-unified
    restart: unless-stopped
    
    # Port mapping - single port for both API and UI
    ports:
      - "8080:8080"  # Backend API + Frontend UI
    
    # Environment variables
    environment:
      - MIMIR_PORT=8080
      - MIMIR_LOG_LEVEL=INFO
      - MIMIR_DATA_DIR=/app/data
      - MIMIR_LOG_DIR=/app/logs
      - MIMIR_PLUGIN_DIR=/app/plugins
      - NEXTJS_URL=http://localhost:3000
      - PORT=3000
      - HOSTNAME=0.0.0.0
      # Ontology and Knowledge Graph settings
      - MIMIR_DB_PATH=/app/data/mimir.db
      - ONTOLOGY_DIR=/app/data/ontologies
      - FUSEKI_URL=http://localhost:3030
      - FUSEKI_DATASET=mimir
      - FUSEKI_BASE=/app/data/tdb2
      - FUSEKI_PORT=3030
      - JENA_HOME=/opt/jena-fuseki
      - JVM_ARGS=-Xmx2g -Xms512m
      # Don't set NEXT_PUBLIC_API_URL - use relative paths from root
    
    # Volume mounts for persistence
    volumes:
      - mimir_data:/app/data
      - mimir_logs:/app/logs
      - mimir_config:/app/config
      - mimir_plugins:/app/plugins
      - mimir_pipelines:/app/pipelines
      - mimir_tdb2:/app/data/tdb2
      - mimir_ontologies:/app/data/ontologies
      - mimir_chromem:/app/data/chromem
    
    # Health check
    healthcheck:
      test: ["CMD", "/app/mimir-aip-server", "--version"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Resource limits (increased for Java + ontology processing)
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 4G
        reservations:
          cpus: '2.0'
          memory: 2G
    
    # Security options
    security_opt:
      - no-new-privileges:true
    read_only: false  # Must be false to write logs/data
    
    # Network
    networks:
      - mimir-network

# Named volumes
volumes:
  mimir_data:
    driver: local
  mimir_logs:
    driver: local
  mimir_config:
    driver: local
  mimir_plugins:
    driver: local
  mimir_pipelines:
    driver: local
  mimir_tdb2:
    driver: local
    driver_opts:
      type: none
      device: ${PWD}/data/tdb2
      o: bind
  mimir_ontologies:
    driver: local
    driver_opts:
      type: none
      device: ${PWD}/data/ontologies
      o: bind
  mimir_chromem:
    driver: local
    driver_opts:
      type: none
      device: ${PWD}/data/chromem
      o: bind

# Networks
networks:
  mimir-network:
    driver: bridge
