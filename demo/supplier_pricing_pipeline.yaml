version: "1"
metadata:
  name: Supplier Pricing API Pipeline
  description: "Automated ingestion of real-time supplier pricing data via API"
  category: "data_ingestion"
  tags: ["supplier", "pricing", "api", "multi-source"]
  created_at: "2026-02-01T10:00:00Z"
  author: "Mimir AIP Demo"
  version: "1.0.0"

# Configuration
config:
  debug: true
  log_level: info
  
# Data Sources - Multiple sources merging into one ontology
data_sources:
  - id: supplier_pricing_api
    type: api
    name: "Supplier Pricing API"
    description: "Real-time pricing from suppliers"
    connection:
      # Will be updated dynamically with container IP
      url: "http://supplier-api:8081/api/v1/suppliers/pricing"
      method: GET
      headers:
        Content-Type: application/json
        X-API-Key: demo-key-12345
      timeout: 30
      retry_count: 3
    extraction:
      format: json
      root_path: suppliers  # Extract from suppliers array
    schedule:
      enabled: true
      cron: "0 */1 * * *"  # Hourly
      timezone: "UTC"
    
# Data merging strategy
merging:
  strategy: upsert  # Update existing, insert new
  key_field: part_id
  conflict_resolution: prefer_api  # API data takes precedence
  version_tracking: true

# Transformation
transformation:
  enabled: true
  steps:
    - name: extract_part_details
      type: json_transform
      description: "Extract and flatten part information"
      config:
        mappings:
          - source: part_id
            target: id
          - source: part_name
            target: name
          - source: unit_price
            target: cost_price
            transform: "float"
          - source: lead_time_days
            target: lead_time
          - source: availability
            target: stock_status
          - source: supplier_name
            target: supplier
          - source: price_change_pct
            target: price_delta_percent
            transform: "float"
    - name: add_metadata
      type: enrich
      description: "Add source and timestamp metadata"
      config:
        fields:
          - name: data_source
            value: "supplier_api"
          - name: ingested_at
            value: "now()"
          - name: update_frequency
            value: "hourly"

# Target - Merge into existing Demo Ingestion pipeline
output:
  target_pipeline: "Demo Ingestion"
  merge_into_ontology: true
  auto_extraction: true
  auto_training: true
  auto_twin_update: true

# Drift Detection
drift_detection:
  enabled: true
  checks:
    - field: cost_price
      type: percentage_change
      threshold: 5.0  # Alert if price changes > 5%
      action: notify_and_reextract
    - field: stock_status
      type: value_change
      threshold: null
      action: notify
    - field: lead_time
      type: numeric_change
      threshold: 2  # Alert if lead time changes by > 2 days
      action: notify
  notification_channels:
    - log
    - webhook: "http://mimir-aip-unified:8080/api/v1/events/drift"

# Monitoring
monitoring:
  enabled: true
  metrics:
    - ingestion_count
    - drift_events
    - merge_conflicts
    - latency_seconds
